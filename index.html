<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Management - CattleLog</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  
  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r border-gray-200 flex flex-col h-screen fixed left-0 top-0 z-20">
    <div class="p-6 border-b border-gray-100 flex items-center gap-3">
      <div class="w-10 h-10 bg-[#34554a] rounded-lg flex items-center justify-center text-white shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>
      </div>
      <div>
        <h1 class="text-gray-900 font-bold text-lg tracking-tight">CattleLog</h1>
        <p class="text-xs text-gray-400 font-medium">Fleet Management</p>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1" id="sidebar-nav">
      <!-- Navigation items rendered by JS -->
    </nav>

    <div class="p-4 border-t border-gray-100">
      <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
        <div class="w-9 h-9 rounded-full bg-[#34554a] flex items-center justify-center text-white text-xs font-bold">AD</div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold text-gray-900 truncate">Admin User</p>
          <p class="text-xs text-gray-400 truncate font-medium">System Manager</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="pl-64 min-h-screen">
    <div class="p-8 max-w-7xl mx-auto" id="main-content">
      <!-- Content rendered by JS -->
    </div>
  </main>

  <!-- Modals Container -->
  <div id="modals-container"></div>

  <script>
    // Icons
    const icons = {
      users: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
      calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>`,
      truck: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>`,
      history: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
      search: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
      plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
      x: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
    };

    // State
    let state = {
      activeTab: 'drivers',
      searchTerm: '',
      statusFilter: '',
      showAddModal: false,
      showViewModal: false,
      showDeleteModal: false,
      showHistoryModal: false,
      modalStep: 1,
      selectedUser: null,
      selectedDriver: null,
      sortKey: 'name',
      sortDir: 'asc'
    };

    // Mock Data
    const MOCK_USERS = [
      { id: 'U-101', name: 'John Smith', email: 'john@cattlemgmt.com', phone: '+1-555-0101', role: 'Staff', status: 'Active' },
      { id: 'U-102', name: 'Jane Doe', email: 'jane@cattlemgmt.com', phone: '+1-555-0102', role: 'Staff', status: 'Active' },
      { id: 'U-103', name: 'Bob Wilson', email: 'bob@cattlemgmt.com', phone: '+1-555-0103', role: 'Staff', status: 'Inactive' },
      { id: 'U-104', name: 'Alice Brown', email: 'alice@cattlemgmt.com', phone: '+1-555-0104', role: 'Staff', status: 'Active' },
    ];

    let drivers = [
      { id: 'D01', name: 'John Smith', phone: '+1-555-0101', status: 'Active', license: 'TX-99210', vehicle: 'VH-001', expiry_date: '2025-06-15', shift_start: '06:00', shift_end: '14:00', source: 'Farm A', destination: 'Market B' },
      { id: 'D02', name: 'Maria Garcia', phone: '+1-555-0102', status: 'Active', license: 'TX-88321', vehicle: 'VH-002', expiry_date: '2025-03-20', shift_start: '14:00', shift_end: '22:00', source: 'Ranch C', destination: 'Farm D' },
      { id: 'D03', name: 'James Wilson', phone: '+1-555-0103', status: 'Inactive', license: 'TX-77432', vehicle: 'None', expiry_date: '2024-12-10', shift_start: '', shift_end: '', source: '', destination: '' },
      { id: 'D04', name: 'Sarah Johnson', phone: '+1-555-0104', status: 'On Route', license: 'TX-66543', vehicle: 'VH-004', expiry_date: '2025-09-05', shift_start: '08:00', shift_end: '16:00', source: 'Auction E', destination: 'Ranch F' },
    ];

    const VEHICLES = [
      { id: 'VH-001', type: 'Cattle Truck', capacity: '20 Head', driver: 'John Smith', status: 'Available' },
      { id: 'VH-002', type: 'Livestock Trailer', capacity: '15 Head', driver: 'Maria Garcia', status: 'In Use' },
      { id: 'VH-003', type: 'Cattle Truck', capacity: '25 Head', driver: 'Unassigned', status: 'Maintenance' },
      { id: 'VH-004', type: 'Transport Van', capacity: '8 Head', driver: 'Sarah Johnson', status: 'Available' },
    ];

    const LOCATIONS = [
      { id: 'LOC-001', name: 'Farm A', type: 'Farm' },
      { id: 'LOC-002', name: 'Market B', type: 'Market' },
      { id: 'LOC-003', name: 'Ranch C', type: 'Ranch' },
      { id: 'LOC-004', name: 'Farm D', type: 'Farm' },
      { id: 'LOC-005', name: 'Auction E', type: 'Auction' },
      { id: 'LOC-006', name: 'Ranch F', type: 'Ranch' },
    ];

    const HISTORY = [
      { date: '2024-01-15', id: 'DEL-0998', driver: 'John S.', cattle: 18, route: 'Farm A → Mkt B', status: 'Completed' },
      { date: '2024-01-14', id: 'DEL-0997', driver: 'Maria G.', cattle: 12, route: 'Ranch C → Frm D', status: 'Completed' },
      { date: '2024-01-14', id: 'DEL-0996', driver: 'James W.', cattle: 10, route: 'Auct E → Rnch F', status: 'Completed' },
      { date: '2024-01-13', id: 'DEL-0995', driver: 'John S.', cattle: 22, route: 'Farm G → Mkt H', status: 'Completed' },
      { date: '2024-01-12', id: 'DEL-0994', driver: 'Sarah J.', cattle: 8, route: 'Ranch I → Frm J', status: 'Issue' },
    ];

    const SCHEDULE_DATA = [
      { name: 'John Smith', mon: '06:00-14:00', tue: '06:00-14:00', wed: 'OFF', thu: '06:00-14:00', fri: '06:00-14:00', sat: '08:00-12:00', sun: 'OFF' },
      { name: 'Maria Garcia', mon: '14:00-22:00', tue: '14:00-22:00', wed: '14:00-22:00', thu: 'OFF', fri: 'OFF', sat: '06:00-14:00', sun: '06:00-14:00' },
      { name: 'James Wilson', mon: 'OFF', tue: 'OFF', wed: '06:00-14:00', thu: '14:00-22:00', fri: '14:00-22:00', sat: 'OFF', sun: 'OFF' },
      { name: 'Sarah Johnson', mon: '06:00-14:00', tue: '06:00-14:00', wed: 'OFF', thu: '06:00-14:00', fri: '06:00-14:00', sat: 'OFF', sun: 'OFF' }
    ];

    // Status Badge Helper
    function getStatusBadge(status) {
      const styles = {
        'Active': 'bg-green-100 text-green-800 border-green-200',
        'Inactive': 'bg-gray-100 text-gray-800 border-gray-200',
        'On Route': 'bg-blue-100 text-blue-800 border-blue-200',
        'Maintenance': 'bg-orange-100 text-orange-800 border-orange-200',
        'In Use': 'bg-purple-100 text-purple-800 border-purple-200',
        'Available': 'bg-green-100 text-green-800 border-green-200',
        'Completed': 'bg-green-100 text-green-800 border-green-200',
        'Issue': 'bg-red-100 text-red-800 border-red-200',
      };
      return `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium border ${styles[status] || 'bg-gray-100'}">${status}</span>`;
    }

    // Render Functions
    function render() {
      renderSidebar();
      renderMainContent();
      renderModals();
      attachEventListeners();
    }

    function renderSidebar() {
      const tabs = [
        { id: 'drivers', icon: icons.users, label: 'All Drivers' },
        { id: 'schedule', icon: icons.calendar, label: 'Schedule' },
        { id: 'fleet', icon: icons.truck, label: 'Vehicle Fleet' },
        { id: 'history', icon: icons.history, label: 'History' },
      ];

      document.getElementById('sidebar-nav').innerHTML = tabs.map(tab => `
        <button 
          onclick="setActiveTab('${tab.id}')"
          class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all text-sm font-medium ${state.activeTab === tab.id ? 'bg-[#34554a] text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}"
        >
          ${tab.icon}
          <span>${tab.label}</span>
        </button>
      `).join('');
    }

    function renderMainContent() {
      const titles = {
        drivers: { title: 'Driver Management', desc: 'Manage driver profiles, licenses, and assignments.' },
        schedule: { title: 'Driver Schedules', desc: 'View and manage weekly shift assignments.' },
        fleet: { title: 'Vehicle Fleet', desc: 'Track vehicles, capacity, and maintenance status.' },
        history: { title: 'Delivery History', desc: 'Review completed deliveries and performance metrics.' }
      };

      const { title, desc } = titles[state.activeTab];
      
      let content = `
        <div class="mb-8">
          <h1 class="text-2xl font-bold text-gray-900 tracking-tight">${title}</h1>
          <p class="text-sm text-gray-500 mt-1">${desc}</p>
        </div>
      `;

      switch(state.activeTab) {
        case 'drivers': content += renderDriversView(); break;
        case 'schedule': content += renderScheduleView(); break;
        case 'fleet': content += renderFleetView(); break;
        case 'history': content += renderHistoryView(); break;
      }

      document.getElementById('main-content').innerHTML = content;
    }

    function renderDriversView() {
      const activeCount = drivers.filter(d => d.status === 'Active').length;
      const inactiveCount = drivers.filter(d => d.status === 'Inactive').length;

      const filteredDrivers = drivers.filter(d => {
        const matchSearch = d.name.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                           d.id.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                           d.license.toLowerCase().includes(state.searchTerm.toLowerCase());
        const matchStatus = !state.statusFilter || d.status === state.statusFilter;
        return matchSearch && matchStatus;
      });

      filteredDrivers.sort((a, b) => {
        let aVal = a[state.sortKey] || '';
        let bVal = b[state.sortKey] || '';
        if (state.sortDir === 'asc') return aVal.localeCompare(bVal);
        return bVal.localeCompare(aVal);
      });

      return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white p-6 rounded-xl border border-gray-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase">Total Drivers</p>
              <p class="text-3xl font-black text-gray-900">${drivers.length}</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl border border-gray-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase">Active</p>
              <p class="text-3xl font-black text-gray-900">${activeCount}</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl border border-red-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase text-red-600">Inactive</p>
              <p class="text-3xl font-black text-red-600">${inactiveCount}</p>
            </div>
          </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
          <div class="flex flex-1 gap-2 w-full md:w-auto">
            <div class="relative flex-1">
              <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.search}</div>
              <input type="text" id="searchInput" placeholder="Search drivers..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 outline-none text-sm focus:ring-2 focus:ring-[#34554a]" value="${state.searchTerm}" />
            </div>
            <select id="statusFilter" class="px-3 py-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-600 text-sm outline-none focus:ring-2 focus:ring-[#34554a]">
              <option value="">All Status</option>
              <option value="Active" ${state.statusFilter === 'Active' ? 'selected' : ''}>Active</option>
              <option value="Inactive" ${state.statusFilter === 'Inactive' ? 'selected' : ''}>Inactive</option>
              <option value="On Route" ${state.statusFilter === 'On Route' ? 'selected' : ''}>On Route</option>
            </select>
          </div>
          <button onclick="openAddModal()" class="flex items-center gap-2 bg-[#34554a] text-white px-4 py-2 rounded-lg font-medium hover:bg-opacity-90 text-sm shadow-sm transition-colors">
            ${icons.plus} Add Driver
          </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
          <div class="overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
              <thead>
                <tr class="bg-[#34554a] text-white text-sm">
                  <th onclick="handleSort('id')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">Driver ID ${getSortIcon('id')}</div></th>
                  <th onclick="handleSort('name')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">Name ${getSortIcon('name')}</div></th>
                  <th onclick="handleSort('phone')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">Phone ${getSortIcon('phone')}</div></th>
                  <th onclick="handleSort('license')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">License ${getSortIcon('license')}</div></th>
                  <th onclick="handleSort('vehicle')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">Vehicle ${getSortIcon('vehicle')}</div></th>
                  <th class="p-4 font-semibold"><div class="flex items-center gap-2">Route</div></th>
                  <th onclick="handleSort('status')" class="p-4 font-semibold cursor-pointer hover:bg-[#2a443b]"><div class="flex items-center gap-2">Status ${getSortIcon('status')}</div></th>
                  <th class="p-4 text-right font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y text-sm text-gray-700">
                ${filteredDrivers.map(driver => `
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 font-mono text-gray-500">${driver.id}</td>
                    <td class="p-4"><span class="font-bold text-gray-900">${driver.name}</span></td>
                    <td class="p-4"><div class="flex items-center gap-2 text-gray-600"><span class="text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></span>${driver.phone}</div></td>
                    <td class="p-4 text-gray-600">${driver.license}</td>
                    <td class="p-4 text-gray-600">${driver.vehicle === 'None' ? '<span class="italic text-gray-400">Unassigned</span>' : driver.vehicle}</td>
                    <td class="p-4 text-gray-600 text-xs">${driver.source && driver.destination ? `<span class="font-medium">${driver.source}</span> <span class="text-gray-400">→</span> <span class="font-medium">${driver.destination}</span>` : '<span class="italic text-gray-400">Not assigned</span>'}</td>
                    <td class="p-4">${getStatusBadge(driver.status)}</td>
                    <td class="p-4 text-right">
                      <div class="flex justify-end gap-3 text-gray-400">
                        <button onclick="openViewModal('${driver.id}')" class="cursor-pointer hover:text-blue-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg></button>
                        <button onclick="openHistoryModal('${driver.id}')" class="cursor-pointer hover:text-amber-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg></button>
                        <button onclick="openEditModal('${driver.id}')" class="cursor-pointer hover:text-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                        <button onclick="openDeleteModal('${driver.id}')" class="cursor-pointer hover:text-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
                ${filteredDrivers.length === 0 ? `<tr><td colspan="7" class="p-8 text-center text-gray-500 italic">No driver records found.</td></tr>` : ''}
              </tbody>
            </table>
          </div>
          <div class="p-4 border-t bg-gray-50 flex items-center justify-between">
            <p class="text-sm text-gray-500 font-medium">Showing ${filteredDrivers.length} of ${drivers.length} records</p>
            <div class="flex gap-2">
              <button class="w-8 h-8 flex items-center justify-center border rounded-lg bg-white disabled:opacity-50 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
              <button class="w-8 h-8 flex items-center justify-center border rounded-lg bg-white disabled:opacity-50 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
            </div>
          </div>
        </div>
      `;
    }

    function getSortIcon(key) {
      if (state.sortKey === key) {
        return state.sortDir === 'asc' 
          ? `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>`
          : `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
      }
      return `<span class="opacity-30"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg></span>`;
    }

    function renderScheduleView() {
      const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
      const dayHeaders = ['Mon 15', 'Tue 16', 'Wed 17', 'Thu 18', 'Fri 19', 'Sat 20', 'Sun 21'];

      return `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
          <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-gray-900">Weekly Shift Planner</h3>
            <div class="flex gap-2">
              <button class="px-4 py-2 bg-[#34554a] text-white rounded-lg text-sm font-semibold hover:bg-opacity-90 transition-colors shadow-sm">+ Add Shift</button>
              <div class="flex items-center gap-1 bg-white border border-gray-200 p-1 rounded-lg">
                <button class="px-3 py-1 bg-[#34554a] text-white shadow-sm rounded-md text-xs font-bold">Week View</button>
                <button class="px-3 py-1 text-xs font-bold text-gray-500 hover:bg-gray-100 rounded-md transition-colors">Day View</button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-center border-collapse">
              <thead>
                <tr class="bg-[#34554a] text-white text-sm">
                  <th class="px-4 py-4 text-left font-semibold border-r border-[#2a443b]">Driver</th>
                  ${dayHeaders.map((day, i) => `<th class="px-4 py-4 font-semibold ${i === 5 ? 'text-amber-200' : ''} ${i === 6 ? 'text-red-200' : ''}">${day}</th>`).join('')}
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 text-sm">
                ${SCHEDULE_DATA.map(row => `
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-left font-bold text-gray-900 border-r border-gray-100">${row.name}</td>
                    ${days.map((day, i) => `
                      <td class="px-2 py-4 ${i === 5 ? 'bg-amber-50/30' : ''} ${i === 6 ? 'bg-red-50/30' : ''}">
                        ${row[day] === 'OFF' 
                          ? '<span class="text-gray-300 text-xs font-bold italic">OFF</span>'
                          : `<div class="bg-[#34554a]/10 text-[#34554a] text-[10px] p-1.5 rounded-md border border-[#34554a]/20 font-bold whitespace-nowrap">${row[day]}</div>`
                        }
                      </td>
                    `).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderFleetView() {
      const availableCount = VEHICLES.filter(v => v.status === 'Available').length;
      const inMaintenanceCount = VEHICLES.filter(v => v.status === 'Maintenance').length;

      return `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white p-6 rounded-xl border border-gray-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase">Total Vehicles</p>
              <p class="text-3xl font-black text-gray-900">${VEHICLES.length}</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl border border-gray-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase">Available</p>
              <p class="text-3xl font-black text-gray-900">${availableCount}</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-xl border border-orange-100 flex items-center gap-5 shadow-sm">
            <div class="w-14 h-14 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 font-bold uppercase text-orange-600">In Maintenance</p>
              <p class="text-3xl font-black text-orange-600">${inMaintenanceCount}</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
          <div class="overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
              <thead>
                <tr class="bg-[#34554a] text-white text-sm">
                  <th class="p-4 font-semibold">Vehicle ID</th>
                  <th class="p-4 font-semibold">Type</th>
                  <th class="p-4 font-semibold">Capacity</th>
                  <th class="p-4 font-semibold">Assigned Driver</th>
                  <th class="p-4 font-semibold">Status</th>
                  <th class="p-4 text-right font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 text-sm text-gray-700">
                ${VEHICLES.map(v => `
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 font-mono font-bold text-[#34554a]">${v.id}</td>
                    <td class="p-4 font-medium text-gray-900">${v.type}</td>
                    <td class="p-4 text-gray-600">${v.capacity}</td>
                    <td class="p-4">
                      ${v.driver === 'Unassigned' 
                        ? '<span class="text-gray-400 italic">No driver assigned</span>'
                        : `<div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-[#34554a] text-white flex items-center justify-center text-[10px] font-bold">${v.driver.charAt(0)}</div><span class="text-gray-700">${v.driver}</span></div>`
                      }
                    </td>
                    <td class="p-4">${getStatusBadge(v.status)}</td>
                    <td class="p-4 text-right"><button class="text-[#34554a] font-semibold text-sm hover:underline">Manage</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderHistoryView() {
      const stats = [
        { label: 'Total Deliveries', value: '1,247', icon: 'checkCircle', color: 'text-green-600', bg: 'bg-green-50' },
        { label: 'Total Cattle', value: '18,450', icon: 'users', color: 'text-blue-600', bg: 'bg-blue-50' },
        { label: 'Avg Time/Trip', value: '2.5 hrs', icon: 'clock', color: 'text-purple-600', bg: 'bg-purple-50' },
        { label: 'Success Rate', value: '98.5%', icon: 'barChart', color: 'text-orange-600', bg: 'bg-orange-50' }
      ];

      const iconsSmall = {
        checkCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>`,
        users: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
        clock: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
        barChart: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
        download: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
        chevronLeft: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
        chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
      };

      return `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          ${stats.map(stat => `
            <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
              <div class="w-8 h-8 ${stat.bg} ${stat.color} rounded-lg flex items-center justify-center mb-3">${iconsSmall[stat.icon]}</div>
              <p class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">${stat.label}</p>
              <p class="text-xl font-black text-gray-900">${stat.value}</p>
            </div>
          `).join('')}
        </div>

        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
          <div class="p-6 border-b border-gray-100 flex flex-wrap gap-4 items-center justify-between bg-gray-50">
            <div class="flex gap-3">
              <select class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-600 outline-none focus:ring-2 focus:ring-[#34554a]">
                <option>Last 30 Days</option>
                <option>Last Quarter</option>
                <option>Year to Date</option>
              </select>
              <select class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-600 outline-none focus:ring-2 focus:ring-[#34554a]">
                <option>All Drivers</option>
                ${drivers.map(d => `<option>${d.name}</option>`).join('')}
              </select>
            </div>
            <button class="flex items-center gap-2 px-5 py-2 bg-[#34554a] text-white rounded-lg font-semibold hover:bg-opacity-90 transition-colors text-sm shadow-sm">
              ${iconsSmall.download} Generate Report
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left whitespace-nowrap">
              <thead>
                <tr class="bg-[#34554a] text-white text-sm">
                  <th class="p-4 font-semibold">Date</th>
                  <th class="p-4 font-semibold">Delivery ID</th>
                  <th class="p-4 font-semibold">Driver</th>
                  <th class="p-4 font-semibold">Cattle Count</th>
                  <th class="p-4 font-semibold">Route</th>
                  <th class="p-4 font-semibold">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 text-sm text-gray-700">
                ${HISTORY.map(h => `
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 text-gray-500">${h.date}</td>
                    <td class="p-4 font-bold text-gray-900">${h.id}</td>
                    <td class="p-4 text-gray-600">${h.driver}</td>
                    <td class="p-4 font-semibold text-gray-900">${h.cattle} Head</td>
                    <td class="p-4 text-gray-500 text-xs italic">${h.route}</td>
                    <td class="p-4">${getStatusBadge(h.status)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="p-4 border-t bg-gray-50 flex items-center justify-between">
            <p class="text-sm text-gray-500 font-medium">Showing 1 to ${HISTORY.length} of ${HISTORY.length} records</p>
            <div class="flex gap-2">
              <button class="w-8 h-8 flex items-center justify-center border rounded-lg bg-white disabled:opacity-50 transition-all">${iconsSmall.chevronLeft}</button>
              <button class="w-8 h-8 flex items-center justify-center border rounded-lg bg-white disabled:opacity-50 transition-all">${iconsSmall.chevronRight}</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderModals() {
      let modals = '';

      // Add/Edit Driver Modal
      if (state.showAddModal) {
        modals += `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] flex flex-col border border-gray-100 animate-fade-in">
              <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50">
                <div>
                  <h3 class="text-lg font-bold text-gray-900">Add New Driver</h3>
                  <p class="text-sm text-gray-500">Step ${state.modalStep} of 2: ${state.modalStep === 1 ? 'Select System User' : 'Complete Driver Profile'}</p>
                </div>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600 transition-colors">${icons.x}</button>
              </div>
              <div class="p-6 overflow-y-auto bg-white custom-scrollbar">
                ${state.modalStep === 1 ? renderModalStep1() : renderModalStep2()}
              </div>
              <div class="p-6 border-t border-gray-100 flex justify-between bg-gray-50">
                <button onclick="closeAddModal()" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-white transition-all font-medium text-sm">Cancel</button>
                <div class="flex gap-3">
                  ${state.modalStep === 2 ? `<button onclick="setModalStep(1)" class="px-4 py-2 border border-gray-200 text-gray-600 font-medium hover:bg-white rounded-lg transition-colors text-sm">Back</button>` : ''}
                  <button onclick="${state.modalStep === 1 ? 'setModalStep(2)' : 'completeDriverAdd()'}" class="px-6 py-2 rounded-lg font-bold transition-all text-sm shadow-md ${state.modalStep === 1 && !state.selectedUser ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-[#34554a] text-white hover:bg-opacity-90'}" ${state.modalStep === 1 && !state.selectedUser ? 'disabled' : ''}>
                    ${state.modalStep === 1 ? 'Next Step' : 'Save Driver'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // View Driver Modal
      if (state.showViewModal && state.selectedDriver) {
        const driver = drivers.find(d => d.id === state.selectedDriver);
        if (driver) {
          modals += `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
              <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 overflow-hidden flex flex-col border border-gray-100 animate-fade-in">
                <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50">
                  <h3 class="text-lg font-bold text-gray-900">Driver Details</h3>
                  <button onclick="closeViewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">${icons.x}</button>
                </div>
                <div class="p-6 space-y-4 bg-white max-h-[60vh] overflow-y-auto custom-scrollbar">
                  <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-[#34554a]/10 text-[#34554a] rounded-full flex items-center justify-center shadow-inner">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div>
                      <h4 class="text-xl font-bold text-gray-900 tracking-tight">${driver.name}</h4>
                      <p class="text-sm text-gray-500 font-medium">${driver.id}</p>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Phone</span><span class="text-sm font-semibold text-gray-900">${driver.phone}</span></div>
                    <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">License</span><span class="text-sm font-semibold text-gray-900">${driver.license}</span></div>
                    <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">License Expiry</span><span class="text-sm font-semibold text-gray-900">${driver.expiry_date || '-'}</span></div>
                    <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Vehicle</span><span class="text-sm font-semibold text-gray-900">${driver.vehicle === 'None' ? '-' : driver.vehicle}</span></div>
                    <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Status</span>${getStatusBadge(driver.status)}</div>
                  </div>
                  <div class="pt-4 mt-4 border-t border-gray-200">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Assignment Schedule</h4>
                    <div class="space-y-3">
                      <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Shift Time</span><span class="text-sm font-semibold text-gray-900">${driver.shift_start && driver.shift_end ? driver.shift_start + ' - ' + driver.shift_end : '-'}</span></div>
                      <div class="flex justify-between border-b pb-2 border-gray-100"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Source</span><span class="text-sm font-semibold text-gray-900">${driver.source || '-'}</span></div>
                      <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Destination</span><span class="text-sm font-semibold text-gray-900">${driver.destination || '-'}</span></div>
                    </div>
                  </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end rounded-b-xl border-t">
                  <button onclick="closeViewModal()" class="px-6 py-2 border bg-white rounded-lg text-sm font-bold shadow-sm hover:bg-gray-50 transition-all text-gray-700">Close Details</button>
                </div>
              </div>
            </div>
          `;
        }
      }

      // Delete Confirmation Modal
      if (state.showDeleteModal && state.selectedDriver) {
        const driver = drivers.find(d => d.id === state.selectedDriver);
        if (driver) {
          modals += `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
              <div class="bg-white rounded-xl shadow-xl w-full max-w-sm mx-4 overflow-hidden animate-fade-in">
                <div class="p-6 text-center">
                  <div class="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                  </div>
                  <h3 class="text-lg font-bold text-gray-900 mb-2">Delete Driver?</h3>
                  <p class="text-sm text-gray-500">Are you sure you want to delete <span class="font-bold">${driver.name}</span>? This action cannot be undone.</p>
                </div>
                <div class="p-4 bg-gray-50 flex gap-3 border-t">
                  <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border bg-white rounded-lg text-sm font-bold hover:bg-gray-50 transition-all text-gray-700">Cancel</button>
                  <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700 transition-all">Delete</button>
                </div>
              </div>
            </div>
          `;
        }
      }

      // History Modal
      if (state.showHistoryModal && state.selectedDriver) {
        const driver = drivers.find(d => d.id === state.selectedDriver);
        if (driver) {
          modals += `
            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
              <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[85vh] flex flex-col border border-gray-100 animate-fade-in">
                <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center rounded-t-xl">
                  <div>
                    <h3 class="font-bold text-gray-900 tracking-tight">Activity History</h3>
                    <p class="text-xs text-gray-500 uppercase font-black tracking-widest mt-1">${driver.name}</p>
                  </div>
                  <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">${icons.x}</button>
                </div>
                <div class="p-8 overflow-y-auto custom-scrollbar bg-white">
                  <div class="space-y-8 relative border-l-2 border-gray-100 ml-3">
                    <div class="relative pl-7">
                      <div class="absolute -left-[10px] top-1 w-4 h-4 rounded-full border-4 border-white shadow-sm bg-[#34554a]"></div>
                      <p class="text-[10px] text-gray-400 font-mono mb-1 font-black">2024-01-15 09:30:00</p>
                      <p class="font-bold text-sm text-gray-800">Completed Delivery DEL-0998</p>
                      <p class="text-xs text-gray-500 mt-1 leading-relaxed font-medium">Delivered 18 head to Market B</p>
                    </div>
                    <div class="relative pl-7">
                      <div class="absolute -left-[10px] top-1 w-4 h-4 rounded-full border-4 border-white shadow-sm bg-gray-200"></div>
                      <p class="text-[10px] text-gray-400 font-mono mb-1 font-black">2024-01-13 14:15:00</p>
                      <p class="font-bold text-sm text-gray-800">Vehicle Assigned</p>
                      <p class="text-xs text-gray-500 mt-1 leading-relaxed font-medium">Assigned to ${driver.vehicle}</p>
                    </div>
                    <div class="relative pl-7">
                      <div class="absolute -left-[10px] top-1 w-4 h-4 rounded-full border-4 border-white shadow-sm bg-gray-200"></div>
                      <p class="text-[10px] text-gray-400 font-mono mb-1 font-black">2024-01-10 08:00:00</p>
                      <p class="font-bold text-sm text-gray-800">Driver Profile Created</p>
                      <p class="text-xs text-gray-500 mt-1 leading-relaxed font-medium">Added to system by Admin</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      }

      document.getElementById('modals-container').innerHTML = modals;
    }

    function renderModalStep1() {
      return `
        <div class="space-y-4">
          <div class="relative">
            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">${icons.search}</div>
            <input type="text" id="modalSearchInput" placeholder="Search users..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm" />
          </div>
          <div class="border border-gray-100 rounded-xl overflow-hidden divide-y divide-gray-50 max-h-60 overflow-y-auto custom-scrollbar">
            ${MOCK_USERS.map(user => `
              <div onclick="selectUser('${user.id}')" class="p-4 flex items-center justify-between cursor-pointer transition-colors ${state.selectedUser?.id === user.id ? 'bg-[#34554a]/5' : 'hover:bg-gray-50'}">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${state.selectedUser?.id === user.id ? 'bg-[#34554a] text-white' : 'bg-gray-100 text-gray-500'}">${user.name.charAt(0)}</div>
                  <div>
                    <p class="font-bold text-gray-900 text-sm">${user.name}</p>
                    <p class="text-xs text-gray-500">${user.email}</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-[10px] uppercase font-bold text-gray-400">${user.role}</span>
                  ${state.selectedUser?.id === user.id ? `<span class="text-[#34554a]"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg></span>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderModalStep2() {
      return `
        <div class="space-y-5">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Selected User</label>
            <div class="p-4 rounded-xl bg-gray-50 border border-gray-100 flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-[#34554a] text-white flex items-center justify-center font-bold">${state.selectedUser?.name.charAt(0)}</div>
              <div>
                <p class="font-bold text-gray-900">${state.selectedUser?.name}</p>
                <p class="text-xs text-gray-500">${state.selectedUser?.email}</p>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">License Number</label>
              <input id="licenseInput" type="text" placeholder="e.g. TX-99120" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm" />
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">License Expiry Date</label>
              <input id="expiryInput" type="date" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm" />
            </div>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Assign Vehicle (Optional)</label>
            <select id="vehicleSelect" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm bg-white">
              <option value="">Select a vehicle...</option>
              ${VEHICLES.filter(v => v.driver === 'Unassigned').map(v => `<option value="${v.id}">${v.id} - ${v.type}</option>`).join('')}
            </select>
          </div>
          <div class="pt-4 border-t border-gray-100">
            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Assignment Schedule</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Shift Start Time</label>
                <input id="shiftStartInput" type="time" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm" />
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Shift End Time</label>
                <input id="shiftEndInput" type="time" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Source Location</label>
                <select id="sourceSelect" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm bg-white">
                  <option value="">Select source...</option>
                  ${LOCATIONS.map(loc => `<option value="${loc.name}">${loc.name} (${loc.type})</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Destination</label>
                <select id="destSelect" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-[#34554a] text-sm bg-white">
                  <option value="">Select destination...</option>
                  ${LOCATIONS.map(loc => `<option value="${loc.name}">${loc.name} (${loc.type})</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Event Handlers
    function setActiveTab(tab) { state.activeTab = tab; state.searchTerm = ''; state.statusFilter = ''; render(); }
    function handleSort(key) { state.sortDir = (state.sortKey === key && state.sortDir === 'asc') ? 'desc' : 'asc'; state.sortKey = key; render(); }
    function openAddModal() { state.showAddModal = true; state.modalStep = 1; state.selectedUser = null; render(); }
    function closeAddModal() { state.showAddModal = false; render(); }
    function setModalStep(step) { if (step === 2 && !state.selectedUser) return; state.modalStep = step; render(); }
    function selectUser(userId) { state.selectedUser = MOCK_USERS.find(u => u.id === userId); render(); }
    function completeDriverAdd() {
      const newDriver = {
        id: `D0${drivers.length + 1}`,
        name: state.selectedUser.name,
        phone: state.selectedUser.phone,
        status: 'Active',
        license: document.getElementById('licenseInput')?.value || 'PENDING',
        vehicle: document.getElementById('vehicleSelect')?.value || 'None',
        expiry_date: document.getElementById('expiryInput')?.value || '',
        shift_start: document.getElementById('shiftStartInput')?.value || '',
        shift_end: document.getElementById('shiftEndInput')?.value || '',
        source: document.getElementById('sourceSelect')?.value || '',
        destination: document.getElementById('destSelect')?.value || ''
      };
      drivers.push(newDriver);
      state.showAddModal = false;
      state.selectedUser = null;
      render();
    }
    function openViewModal(id) { state.selectedDriver = id; state.showViewModal = true; render(); }
    function closeViewModal() { state.showViewModal = false; state.selectedDriver = null; render(); }
    function openEditModal(id) { openViewModal(id); }
    function openDeleteModal(id) { state.selectedDriver = id; state.showDeleteModal = true; render(); }
    function closeDeleteModal() { state.showDeleteModal = false; state.selectedDriver = null; render(); }
    function confirmDelete() { drivers = drivers.filter(d => d.id !== state.selectedDriver); closeDeleteModal(); }
    function openHistoryModal(id) { state.selectedDriver = id; state.showHistoryModal = true; render(); }
    function closeHistoryModal() { state.showHistoryModal = false; state.selectedDriver = null; render(); }

    function attachEventListeners() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          state.searchTerm = e.target.value;
          render();
          const newInput = document.getElementById('searchInput');
          if (newInput) { newInput.focus(); newInput.setSelectionRange(state.searchTerm.length, state.searchTerm.length); }
        });
      }
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', (e) => { state.statusFilter = e.target.value; render(); });
      }
    }

    // Global functions
    window.setActiveTab = setActiveTab;
    window.handleSort = handleSort;
    window.openAddModal = openAddModal;
    window.closeAddModal = closeAddModal;
    window.setModalStep = setModalStep;
    window.selectUser = selectUser;
    window.completeDriverAdd = completeDriverAdd;
    window.openViewModal = openViewModal;
    window.closeViewModal = closeViewModal;
    window.openEditModal = openEditModal;
    window.openDeleteModal = openDeleteModal;
    window.closeDeleteModal = closeDeleteModal;
    window.confirmDelete = confirmDelete;
    window.openHistoryModal = openHistoryModal;
    window.closeHistoryModal = closeHistoryModal;

    // Initial render
    render();
  </script>
</body>
</html>
